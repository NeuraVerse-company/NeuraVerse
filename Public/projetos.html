<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversa com IA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000000;
            color: white;
        }
        #mic-button {
            padding: 10px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }
        #mic-button.listening {
            background-color: #ff4444;
        }
        #status {
            color: #ff4444;
            font-size: 14px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <button id="mic-button">ðŸŽ¤</button>
    <div id="status">Por favor, ative o microfone para conversar.</div>

    <!-- Carrega o Speech SDK via CDN -->
    <script src="https://unpkg.com/@microsoft/cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"
            onerror="document.getElementById('status').style.display = 'block'; document.getElementById('status').textContent = 'Erro ao carregar o Speech SDK. Verifique sua conexÃ£o.';"></script>

    <script>
        if (!window.Microsoft || !window.Microsoft.CognitiveServices || !window.Microsoft.CognitiveServices.Speech) {
            console.error("SpeechSDK nÃ£o carregado.");
            document.getElementById("status").style.display = "block";
            document.getElementById("status").textContent = "Erro ao carregar o Speech SDK. Tente novamente.";
        } else {
            const SpeechSDK = window.Microsoft.CognitiveServices.Speech;
            const { SpeechConfig, AudioConfig, SpeechRecognizer } = SpeechSDK;

            // ConfiguraÃ§Ãµes do Azure Speech Service
            const subscriptionKey = "SUA_CHAVE_DO_AZURE_SPEECH"; // Substitua pela sua chave
            const region = "brazilsouth"; // Confirme a regiÃ£o
            const speechConfig = SpeechConfig.fromSubscription(subscriptionKey, region);
            speechConfig.speechRecognitionLanguage = "pt-BR";

            // Elementos da interface
            const micButton = document.getElementById("mic-button");
            const status = document.getElementById("status");
            let recognizer = null;
            let isProcessing = false;

            // Iniciar reconhecimento de voz
            function startRecognition() {
                const audioConfig = AudioConfig.fromDefaultMicrophoneInput();
                recognizer = new SpeechRecognizer(speechConfig, audioConfig);
                micButton.classList.add("listening");

                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(() => {
                        status.style.display = "none";
                        recognizer.recognized = (s, e) => {
                            if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech && !isProcessing) {
                                isProcessing = true;
                                status.textContent = "Ouvindo: " + e.result.text;
                                processInput(e.result.text);
                            }
                        };
                        recognizer.canceled = (s, e) => {
                            console.error("Reconhecimento cancelado:", e.errorDetails);
                            status.style.display = "block";
                            status.textContent = "Erro no reconhecimento de voz.";
                            restartRecognition();
                        };
                        recognizer.sessionStopped = () => restartRecognition();
                        recognizer.startContinuousRecognitionAsync(
                            () => console.log("Reconhecimento iniciado"),
                            (err) => {
                                console.error("Erro ao iniciar:", err);
                                status.style.display = "block";
                                status.textContent = "Erro ao iniciar o reconhecimento.";
                            }
                        );
                    })
                    .catch((err) => {
                        console.error("Microfone nÃ£o disponÃ­vel:", err);
                        status.style.display = "block";
                        status.textContent = "Microfone nÃ£o disponÃ­vel. Verifique as permissÃµes.";
                    });
            }

            // Reiniciar reconhecimento
            function restartRecognition() {
                if (recognizer) {
                    recognizer.stopContinuousRecognitionAsync(
                        () => {
                            recognizer.close();
                            recognizer = null;
                            startRecognition();
                        },
                        (err) => console.error("Erro ao parar:", err)
                    );
                }
            }

            // Processar entrada com Azure OpenAI
            async function processInput(input) {
                const apiKey = "SUA_CHAVE_OPENAI_AZURE"; // Substitua pela sua chave
                const endpoint = "SEU_ENDPOINT_OPENAI"; // Substitua pelo seu endpoint
                const deployment = "SEU_DEPLOYMENT_NAME"; // Substitua pelo nome do deployment
                const url = `${endpoint}/openai/deployments/${deployment}/chat/completions?api-version=2023-05-15`;

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "api-key": apiKey
                        },
                        body: JSON.stringify({
                            messages: [
                                { role: "system", content: "VocÃª Ã© um amigo prÃ³ximo, conversando de forma descontraÃ­da e natural em portuguÃªs brasileiro." },
                                { role: "user", content: input }
                            ],
                            max_tokens: 150,
                            temperature: 0.7
                        })
                    });
                    if (!response.ok) throw new Error("Erro na resposta da API");
                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content.trim();
                    status.textContent = "IA: " + aiResponse;
                    speakResponse(aiResponse);
                } catch (err) {
                    console.error(err);
                    status.textContent = "Erro ao processar a solicitaÃ§Ã£o.";
                    speakResponse("Desculpe, deu um erro aqui. Vamos tentar de novo?");
                }
            }

            // Falar resposta com ElevenLabs
            async function speakResponse(text) {
                const elevenLabsApiKey = "SUA_CHAVE_ELEVENLABS"; // Substitua pela sua chave
                const voiceId = "SEU_VOICE_ID"; // Substitua pelo ID da voz
                const url = `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`;

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "xi-api-key": elevenLabsApiKey
                        },
                        body: JSON.stringify({
                            text: text,
                            model_id: "eleven_multilingual_v2",
                            voice_settings: { stability: 0.5, similarity_boost: 0.5 }
                        })
                    });
                    if (!response.ok) throw new Error("Erro na resposta do ElevenLabs");
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onplay = () => { isProcessing = false; };
                } catch (err) {
                    console.error(err);
                    status.textContent = "Erro ao sintetizar a voz.";
                    isProcessing = false;
                }
            }

            // Iniciar ao carregar
            window.onload = () => startRecognition();
        }
    </script>
</body>
</html>