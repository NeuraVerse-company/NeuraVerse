<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversa com IA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000000;
            color: white;
        }
        #mic-button {
            padding: 10px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }
        #mic-button.listening {
            background-color: #ff4444;
        }
        #status {
            color: #ff4444;
            font-size: 14px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <button id="mic-button">ðŸŽ¤</button>
    <div id="status">Por favor, ative o microfone para conversar.</div>

    <!-- Carrega o Speech SDK localmente usando caminho absoluto -->
    <script src="/microsoft.cognitiveservices.speech.sdk.bundle-min.js"
            id="speech-sdk-script"
            onerror="document.getElementById('status').style.display = 'block'; document.getElementById('status').textContent = 'Erro ao carregar o Speech SDK. Verifique se o arquivo estÃ¡ na pasta correta.';"></script>

    <script>
        // FunÃ§Ã£o principal que serÃ¡ chamada quando o Speech SDK carregar
        function initializeSpeechSDK() {
            if (!window.Microsoft || !window.Microsoft.CognitiveServices || !window.Microsoft.CognitiveServices.Speech) {
                console.error("SpeechSDK nÃ£o carregado.");
                document.getElementById("status").style.display = "block";
                document.getElementById("status").textContent = "Erro ao carregar o Speech SDK. Tente novamente.";
                return;
            }

            const SpeechSDK = window.Microsoft.CognitiveServices.Speech;
            const { SpeechConfig, AudioConfig, SpeechRecognizer } = SpeechSDK;

            // ConfiguraÃ§Ãµes do Azure Speech Service
            const subscriptionKey = "34fnIXKyvJueY9akKmYlYVYstfvK2hmgIxY0szjdvsAYAvFjgH7aJQQJ99BCACYeBjFXJ3w3AAAYACOGhTJG"; // Substitua pela sua chave real
            const region = "eastus"; // Confirme a regiÃ£o
            const speechConfig = SpeechConfig.fromSubscription(subscriptionKey, region);
            speechConfig.speechRecognitionLanguage = "pt-BR";

            // Elementos da interface
            const micButton = document.getElementById("mic-button");
            const status = document.getElementById("status");
            let recognizer = null;
            let isProcessing = false;

            // Iniciar reconhecimento de voz
            function startRecognition() {
                const audioConfig = AudioConfig.fromDefaultMicrophoneInput();
                recognizer = new SpeechRecognizer(speechConfig, audioConfig);
                micButton.classList.add("listening");

                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(() => {
                        status.style.display = "none";
                        recognizer.recognized = (s, e) => {
                            if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech && !isProcessing) {
                                isProcessing = true;
                                status.textContent = "Ouvindo: " + e.result.text;
                                processInput(e.result.text);
                            }
                        };
                        recognizer.canceled = (s, e) => {
                            console.error("Reconhecimento cancelado:", e.errorDetails);
                            status.style.display = "block";
                            status.textContent = "Erro no reconhecimento de voz.";
                            restartRecognition();
                        };
                        recognizer.sessionStopped = () => restartRecognition();
                        recognizer.startContinuousRecognitionAsync(
                            () => console.log("Reconhecimento iniciado"),
                            (err) => {
                                console.error("Erro ao iniciar:", err);
                                status.style.display = "block";
                                status.textContent = "Erro ao iniciar o reconhecimento.";
                            }
                        );
                    })
                    .catch((err) => {
                        console.error("Microfone nÃ£o disponÃ­vel:", err);
                        status.style.display = "block";
                        status.textContent = "Microfone nÃ£o disponÃ­vel. Verifique as permissÃµes.";
                    });
            }

            // Reiniciar reconhecimento
            function restartRecognition() {
                if (recognizer) {
                    recognizer.stopContinuousRecognitionAsync(
                        () => {
                            recognizer.close();
                            recognizer = null;
                            startRecognition();
                        },
                        (err) => console.error("Erro ao parar:", err)
                    );
                }
            }

            // Processar entrada com Azure OpenAI
            async function processInput(input) {
                const apiKey = "9Y2rjq7DuAOFhDL8n8zrJcgK9kfydyNtnv3p21iCR0YCCM6gRNfhJQQJ99BCACHrzpqXJ3w3AAABACOGuH95"; // Substitua pela sua chave real
                const endpoint = "https://brunoia-openai-1.openai.azure.com/"; // Substitua pelo seu endpoint real
                const deployment = "BrunoAI-01"; // Substitua pelo nome do deployment real
                const url = `${endpoint}/openai/deployments/${deployment}/chat/completions?api-version=2023-05-15`;

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "api-key": apiKey
                        },
                        body: JSON.stringify({
                            messages: [
                                { role: "system", content: "VocÃª Ã© Bruno Perini, criador do canal 'VocÃª Mais Rico', especialista em finanÃ§as e investimentos. Seu objetivo Ã© ensinar as pessoas a investir de forma inteligente, construir patrimÃ´nio e alcanÃ§ar independÃªncia financeira.VocÃª explica conceitos financeiros com profundidade, fornecendo exemplos prÃ¡ticos e embasando suas respostas com lÃ³gica e referÃªncias do mercado. VocÃª evita respostas curtas e sempre detalha seus argumentos para garantir que a pessoa compreenda o tema por completo.AlÃ©m do canal 'VocÃª Mais Rico', vocÃª e sua esposa, Malu Perini, comandam o canal 'Os SÃ³cios' no YouTube, onde discutem finanÃ§as, economia, empreendedorismo e desenvolvimento pessoal. VocÃª se comunica de forma clara, didÃ¡tica e objetiva, sempre trazendo insights valiosos sobre o mundo dos investimentos."},
                                { role: "user", content: input }
                            ],
                            max_tokens: 150,
                            temperature: 0.7
                        })
                    });
                    if (!response.ok) throw new Error("Erro na resposta da API");
                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content.trim();
                    status.textContent = "IA: " + aiResponse;
                    speakResponse(aiResponse);
                } catch (err) {
                    console.error(err);
                    status.textContent = "Erro ao processar a solicitaÃ§Ã£o.";
                    speakResponse("Desculpe, deu um erro aqui. Vamos tentar de novo?");
                }
            }

            // Falar resposta com ElevenLabs
            async function speakResponse(text) {
                const elevenLabsApiKey = "sk_c2e182e7c61c537ad902cdd7248f46ffd50cd24db42bb405"; // Substitua pela sua chave real
                const voiceId = "IKne3meq5aSn9XLyUdCD"; // Substitua pelo ID da voz real
                const url = `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`;

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "xi-api-key": elevenLabsApiKey
                        },
                        body: JSON.stringify({
                            text: text,
                            model_id: "eleven_multilingual_v2",
                            voice_settings: { stability: 0.5, similarity_boost: 0.5 }
                        })
                    });
                    if (!response.ok) throw new Error("Erro na resposta do ElevenLabs");
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onplay = () => { isProcessing = false; };
                } catch (err) {
                    console.error(err);
                    status.textContent = "Erro ao sintetizar a voz.";
                    isProcessing = false;
                }
            }

            // Iniciar o reconhecimento
            startRecognition();
        }

        // Espera o script do Speech SDK carregar antes de inicializar
        window.onload = () => {
            const script = document.getElementById("speech-sdk-script");
            script.addEventListener("load", initializeSpeechSDK);
            script.addEventListener("error", () => {
                console.error("Erro ao carregar o Speech SDK.");
                document.getElementById("status").style.display = "block";
                document.getElementById("status").textContent = "Erro ao carregar o Speech SDK. Verifique se o arquivo estÃ¡ na pasta correta.";
            });
        };
    </script>
</body>
</html>
